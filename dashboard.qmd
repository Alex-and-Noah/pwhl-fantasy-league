```{r imports}
library(tidyverse)
library(gt)
library(bslib)
library(shiny)
library(bsicons)
library(ggimage)
library(rsvg)

invisible(
  lapply(
    list.files(
      "./R",
      full.names = TRUE
    ),
    source
  )
)

pool <- 30
```

```{r "Get season dates and type"}
current_date = today()
# current_date = "2025-04-22"

season_dates_and_type <- get_season_dates_and_type()

days_for_current_date <- get_days_for_current_date(
  current_date,
  season_dates_and_type
)

last_game_day_date <- days_for_current_date$last_game_day_date |>
  as.character()
next_game_day_date <- days_for_current_date$next_game_day_date |>
  as.character()
season_id <- days_for_current_date$season_id |>
  as.numeric()
season <- days_for_current_date$season |>
  as.numeric()
game_type <- days_for_current_date$game_type |>
  as.character()
```

```{r "Get team and schedule data"}
team_data_frames <- get_all_teams(
  season_id,
  season,
  game_type
)

team_logo_urls <- team_data_frames["team_logo_urls"][[1]]
teams <- team_data_frames["teams"][[1]]
team_codes <- team_data_frames["team_codes"][[1]]
all_teams <- team_data_frames["all_teams"][[1]]

schedules <- get_schedule(
  season_id,
  team_codes,
  team_logo_urls,
  season_dates_and_type,
  last_game_day_date,
  next_game_day_date,
  current_date
)

schedule <- schedules["schedule"][[1]] |>
    mutate(
        game_date = game_date |> as.Date()
    )

schedule_to_date <- schedules["schedule_to_date"][[1]]
last_game_day_date <- schedules["last_game_day_date"][[1]]
next_game_day_date <- schedules["next_game_day_date"][[1]]
last_game_day <- schedules["last_game_day"][[1]]
next_game_day <- schedules["next_game_day"][[1]]
```

```{r "Get Fantasy teams and standings"}
fantasy_teams_and_standings <- get_fantasy_teams_and_standings(
  all_teams,
  schedule_to_date,
  schedule
)

team_images <- fantasy_teams_and_standings["team_images"][[1]]
team_colours <- fantasy_teams_and_standings["team_colours"][[1]]
team_rosters <- fantasy_teams_and_standings["team_rosters"][[1]]
roster_points_per_game <- fantasy_teams_and_standings[
  "roster_points_per_game"
][[1]]
standings <- fantasy_teams_and_standings["standings"][[1]] |>
  mutate(
    Team = case_when(
      is.na(Team) ~ "logo.svg",
      .default = Team
    )
  )

if (typeof(last_game_day) != "logical") {
  last_game_day <- last_game_day |>
    mutate(
      roster_points_per_game[game_id, ]
    )
}
```

# Overview

## Row

```{r "next game day"}
p_args <- next_game_day |>
  mutate(
    temp = paste0(
      home_team_code,
      " @ ",
      away_team_code,
      ", ",
      game_status
    )
  ) |>
  select(
    temp
  )

p_args <- map(
  p_args[, 1],
  p
)

value_box(
  title = "Next game day",
  showcase = bs_icon(
    "calendar-event",
    size = "6vh"
  ),
  value = tags$p(
    format(
      as.Date(
        next_game_day_date,
        format = "%Y-%m-%d"
      ),
      "%b %e, %Y"
    ),
    style = "font-size: 4vh;"
  ),
  theme = "success",
  !!!p_args
)
```

```{r "last game day"}
if (
  nrow(
    roster_points_per_game
  ) ==
    0
) {
  value_box(
    title = "No data available",
    showcase = bs_icon(
      "hourglass-split",
      size = "6vh"
    ),
    value = tags$p(
      "No games played yet this season",
      style = "font-size: 4vh;"
    ),
    theme = "danger"
  )
} else {
  last_game_day |>
    mutate(
      temp = "-"
    ) |>
    select(
      c(
        "home_team_code",
        "home_team_logo",
        "home_score",
        "temp",
        "away_score",
        "away_team_logo",
        "away_team_code"
      )
    ) |>
    gt() |>
    tab_header(
      format(
        last_game_day_date,
        "Last game day (%B %e, %Y)"
      )
    ) |>
    text_transform(
      locations = cells_body(
        columns = c(
          "home_team_logo",
          "away_team_logo"
        )
      ),
      fn = function(x) {
        web_image(
          url = x,
          height = "5vh"
        )
      }
    ) |>
    cols_label(
      home_team_code = "",
      home_team_logo = "Home",
      home_score = "",
      temp = "",
      away_score = "",
      away_team_logo = "Away",
      away_team_code = ""
    ) |>
    tab_options(
    table.background.color = "#F5F5F5",
    column_labels.background.color = "#2B2D42",
    table.font.size = px(16),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table_body.hlines.color = "transparent",
    table_body.border.bottom.color = "transparent",
    column_labels.border.bottom.color = "transparent",
    column_labels.border.top.color = "transparent"
  ) |> 
  tab_style_body(
    style = cell_borders(
      sides = c("top", "right", "left", "bottom"),
      weight = px(0) # Remove row borders
    ),
    fn = function(x) { is.numeric(x) | is.character(x) }
  ) |> 
  opt_css(
    css = "

    table tr:nth-child(odd) {
      background-color: #e0dedeff;
    }

    .gt_col_heading {
      position: sticky !important;
      top: 0px !important;
      z-index: 10 !important;
    }
    "
  )
}

```

```{r}

temps <- data.table(temp = seq(from = 0, to = pool, by = 0.01))
temps[, temp1 := shift(temp, 1)]

ggplot(temps, aes(x = 1)) +
    geom_segment(
      aes(y = 0, yend = 100),
      linewidth = 10,
      lineend = c("round"),
      color = "black"
    ) +
    geom_segment(
      aes(y = 0, yend = 100),
      linewidth = 9,
      lineend = c("round"),
      color = "white"
    ) +
    geom_segment(
      data = temps[1:1000],
      aes(y = temp, yend = temp1), color = "#5F259F",
      lineend = c("round"),
      linewidth = 9
    ) +
    geom_segment(
      data = temps[-(1:1000)],
      aes(y = temp, yend = temp1), color = "#5F259F",
      lineend = c("square"),
      linewidth = 9
    ) +
    theme_void() +
    labs(
      title = paste0("Prize pool: ", pool, "$")
    ) +
    theme(
      plot.title = element_text(size = 50, hjust = 0.5)
    )

```

## Row

Need help making your team? Generate a random regulation team [here](#team-generator) to paste into the [Google Sheet](https://docs.google.com/spreadsheets/d/1sywjZ6quCmbLBq_wEEXZEDzcW0NeBpCtRaT3W1hDkhI/edit?usp=sharing)


## Row

```{r "standings overview"}
#| title: "Standings"
standings |>
  mutate(
    delta = roster_points_per_game |>
      filter(
        game_date == last_game_day_date
      ) |>
      compute_standings(
        team_images
      ) |>
      pull(
        Points
      )
  ) |>
  mutate(
    Points = paste0(
      Points,
      " (+",
      delta,
      ")"
    )
  ) |>
  select(
    c(
      Name,
      Team,
      Points
    )
  ) |>
  gt() |>
  text_transform(
    locations = cells_body(
      columns = Team
    ),
    fn = function(x) {
      web_image(
        url = x,
        height = "5vh"
      )
    }
  ) |>
    tab_options(
    table.background.color = "#F5F5F5",
    column_labels.background.color = "#2B2D42",
    table.font.size = px(16),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table_body.hlines.color = "transparent",
    table_body.border.bottom.color = "transparent",
    column_labels.border.bottom.color = "transparent",
    column_labels.border.top.color = "transparent"
  ) |> 
  tab_style_body(
    style = cell_borders(
      sides = c("top", "right", "left", "bottom"),
      weight = px(0) # Remove row borders
    ),
    fn = function(x) { is.numeric(x) | is.character(x) }
  ) |> 
  opt_css(
    css = "

    table tr:nth-child(odd) {
      background-color: #e0dedeff;
    }

    .gt_col_heading {
      position: sticky !important;
      top: 0px !important;
      z-index: 10 !important;
    }
    "
  )
```

## Row

```{r "Text: last update (data)"}
#| content: valuebox
#| title: "Last updated"
list(
  icon = "clock-history",
  value = format(
    now(tzone = "America/New_York"),
    "%b. %d, '%y, %H:%M"
  )
)
```

# Draft Info

## Row

::: {.card title="Rules"}
Choose your fantasy team name, colour, logo and roster in the [Google Sheet](https://docs.google.com/spreadsheets/d/1sywjZ6quCmbLBq_wEEXZEDzcW0NeBpCtRaT3W1hDkhI/edit?usp=sharing). (If you want some inspiration for your draft, you can check out the [team generator](#team-generator))<br>
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”´ğŸŸ¡ğŸ”µ**Team Colour:** Valid hexadecimal colour code<br>
&nbsp;&nbsp;&nbsp;&nbsp;ğŸ‘©â€ğŸ‘©â€ğŸ‘§ğŸ“·ğŸ–¥ï¸**Team Image:** Valid link to any `.svg` image on the web<br><br>
Your team should have exactly the following (the Google Sheet dropdowns force this structure, don't worry!):<br>
&nbsp;&nbsp;&nbsp;&nbsp;**ğŸ’ 6 forwards**<br>
&nbsp;&nbsp;&nbsp;&nbsp;**ğŸ›¡ï¸ 4 defenders**<br>
&nbsp;&nbsp;&nbsp;&nbsp;**ğŸ¥… 2 goalies**<br><br>
ğŸ˜®â€ğŸ’¨ Players/goalies aren't restricted to a single fantasy team so if someone took a player you like, you can take them too!<br><br>
â†”ï¸ **Trades:** Throughout the season, you are allowed **exactly 1 trade** (respecting the team structure). Your new player only contributes points to your fantasy score starting the day after the trade. Please **let Alex or Noah know directly** if/when you make a trade!<br><br>
ğŸ• **Deadline:** You can use all of November's pre-season and regular season games to scout your roster and aim to lock it in by **November 30th, 2025**! After this date, the Google Sheet will be ğŸ‘ï¸**View Only**ğŸ‘ï¸<br><br>
ğŸ’°ğŸ’µğŸ’¸ **Prize pool (Optional):** E-transfer $10 to Alex or Noah to enter in the fantasy prize pool! More information TBD but you could **WIN BIGGGG! (Send an e-transfer or intent to e-transfer by the roster deadline to enter the prize pool)**
:::

## Row

::: {.card title="Scoring"}
Your fantasy team's score is updated daily with data from the previous day's games. Each day, each member of your fantasy roster will contribute a number of points to your team's overall score, following the scheme below:

ğŸ’ 1 point per goal<br>
ğŸ¤ 1 point per assist<br>
âœ¨ 2 points per win<br>
ğŸ˜– 0 points per loss<br>
ğŸ¥‡ 1 point per OT loss

You can check how your and everyone else's teams are doing [here](#team-standings).
:::

# Team Standings

## Row

```{r "standings full"}
#| title: "Standings"
standings |>
  gt() |>
  text_transform(
    locations = cells_body(
      columns = Team
    ),
    fn = function(x) {
      web_image(
        url = x,
        height = "5vh"
      )
    }
  ) |>
    tab_options(
    table.background.color = "#F5F5F5",
    column_labels.background.color = "#2B2D42",
    table.font.size = px(16),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table_body.hlines.color = "transparent",
    table_body.border.bottom.color = "transparent",
    column_labels.border.bottom.color = "transparent",
    column_labels.border.top.color = "transparent"
  ) |> 
  tab_style_body(
    style = cell_borders(
      sides = c("top", "right", "left", "bottom"),
      weight = px(0) # Remove row borders
    ),
    fn = function(x) { is.numeric(x) | is.character(x) }
  ) |> 
  opt_css(
    css = "

    table tr:nth-child(odd) {
      background-color: #e0dedeff;
    }

    .gt_col_heading {
      position: sticky !important;
      top: 0px !important;
      z-index: 10 !important;
    }
    "
  )
```

## Row

```{r "standings over time"}
#| title: "Standings over time"

if (
  nrow(
    roster_points_per_game
  ) ==
    0
) {
  value_box(
    title = "No data available",
    showcase = bs_icon(
      "hourglass-split",
      size = "6vh"
    ),
    value = tags$p(
      "No games played yet this season",
      style = "font-size: 4vh;"
    ),
    theme = "danger"
  )
} else {
  data <- roster_points_per_game |>
    mutate(
      across(
        names(team_rosters),
        ~ .x |> as.numeric() |> cumsum()
      ),
      game_idx = 1:nrow(
        roster_points_per_game
      )
    ) |>
    pivot_longer(
      cols = names(team_rosters),
      names_to = "Team",
      values_to = "Points"
    ) |>
    rename("Game" = game_idx)

  #TODO this needs to be moved ig
  standings <- standings |>
    mutate(
      colours = team_colours
    )

  data |>
    ggplot() +
    geom_line(
      aes(
        x = Game,
        y = Points,
        colour = Team
      ),
      linewidth = 2
    ) +
    scale_color_manual(values = standings$colours) +
    geom_point(
      data = standings,
      aes(
        x = max(data$Game),
        y = Points,
        colour = Name
      ),
      size = 10,
      colour = standings$colours
    ) +
    geom_image(
      data = standings,
      aes(
        x = max(data$Game),
        y = Points,
        image = Team
      )
    ) +
    guides(colour = guide_legend(override.aes = list(size = 10))) +
    theme_minimal()
}
```

# Team Rosters

::: {.panel-tabset}

```{r "team rosters"}
#| output: asis
res <- purrr::map_chr(
  unique(names(team_rosters)),
  function(name) {
    knitr::knit_child(
      text = c(
        "## `r name`",
        "",
        "```{r}",
        "#| echo: false",
        "html(",
        "    web_image(",
        "        url = team_images[[name]],",
        "        height = '50px'",
        "    )",
        ")",
        "team_rosters[[name]] |>",
        "    select(",
        "        c(",
        "            'jersey_number',",
        "            'player_headshot',",
        "            'player_name',",
        "            'position',",
        "            'primary_hand',",
        "            'dob',",
        "            'home_town'",
        "        )",
        "    ) |>",
        "    rename(",
        "        c(",
        "            '#' = 'jersey_number',",
        "            Headshot = 'player_headshot',",
        "            Name = 'player_name',",
        "            Pos = 'position',",
        "            Shoots = 'primary_hand',",
        "            DOB = 'dob',",
        "            'Home town' = 'home_town'",
        "        )",
        "    ) |>",
        "   gt() |>",
        "   text_transform(",
        "        locations = cells_body(columns = Headshot),",
        "        fn = function(x) {",
        "            web_image(",
        "                url = x,",
        "                height = '50px'",
        "            )",
        "        }",
        "    )",
        "```",
        "",
        ""
      ),
      envir = environment(),
      quiet = TRUE
    )
  }
)

cat(res, sep = '\n')
```
:::

# Schedule

```{r "Schedule"}

schedule |>
    select(
        c(
            game_date,
            game_status,
            away_team_logo,
            # away_team_code,
            away_score,
            home_team_logo,
            # home_team_code,
            home_score
        )
    ) |>
    mutate(
        game_date = as.Date(
                game_date,
                format="%Y-%m-%d"
            ) |>
            format(
                "%a, %b %e"
            )
    ) |>
    gt() |>
    fmt_image(
        columns = c(
            away_team_logo,
            home_team_logo
        )
        # width = "1.5em",
        # height = "2em"
    ) |>
    cols_align(
        align = "center",
        columns = c(
            game_status,
            away_score,
            home_score
        )
    ) |>
    cols_width(
        game_date ~ pct(20),
        game_status ~ pct(20),
        away_team_logo ~ pct(10),
        away_score ~ pct(10),
        home_team_logo ~ pct(10),
        home_score ~ pct(10)
    ) |>
    cols_label(
        game_date = "Date",
        game_status = "Time",
        away_team_logo = "Away",
        away_score = "Score",
        home_team_logo = "Home",
        home_score = "Score"
    )
```


# Team Generator {#team-generator}

Select one of the rows in this table to use (or take some inspo from)

```{r generate-team}

seed <- 1

random_teams <- data.frame(matrix(ncol = 12, nrow = 0)) |> set_names("F1", "F2", "F3", "F4", "F5", "F6", "D1", "D2", "D3", "D4", "G1", "G2")

for (i in 1:50) {
  random_team <- all_teams |> mutate(
    position = case_when(
      position == "C" ~ "F",
      position == "LW" ~ "F",
      position == "RW" ~ "F",
      position == "LD" ~ "D",
      position == "RD" ~ "D",
      .default = position
    )
  ) |> 
    group_by(position) |>
    slice_sample(
      n = 6
    ) |> ungroup()

    random_teams <- rbind(
      random_teams,
      rbind(
        random_team |> filter(position == "F") |> select(player_name),
        random_team |> filter(position == "D") |> slice(1:4) |> select(player_name),
        random_team |> filter(position == "G") |> slice(1:2) |> select(player_name)
      ) |> transpose() |> set_names(
        "F1", "F2", "F3", "F4", "F5", "F6", "D1", "D2", "D3", "D4", "G1", "G2"
      )
    )
  
}

random_teams <- cbind(
  Team_name = slice_sample(read.csv("static/common_words.csv"), n = 50),
  Team_colour = sample(rgb(
  t(col2rgb(colors())),
  maxColorValue = 255
), 50), random_teams
)

library(DT)

random_teams |> datatable()

```
